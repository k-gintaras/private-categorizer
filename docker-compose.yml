services:
  media-server:
    build:
      context: ./media-server
      dockerfile: Dockerfile
    environment:
      - IS_DOCKER=true
      - ROOT_DIRECTORY=/mnt/ssd
      - FILE_DB_PATH=/mnt/ssd/file_paths.db
      - MEDIA_SERVER_PORT=${MEDIA_SERVER_PORT}
      - SERVER_URL=${SERVER_URL}
    volumes:
      - '${DOCKER_VOLUME_PATH}:/mnt/ssd'
    ports:
      - '${MEDIA_SERVER_PORT}:${MEDIA_SERVER_PORT}'
    command: >
      sh -c "node /app/scripts/configure-env.js > /tmp/env && . /tmp/env && node /app/server.js"

  media-viewer:
    build:
      context: .
      dockerfile: ./media-viewer/Dockerfile
    ports:
      - '5000:5000'
    volumes:
      # This ensures the `dist` folder is mapped correctly in the container.
      - ./media-viewer/dist/media-viewer/browser:/app/dist:ro
    depends_on:
      - media-server
